# 计算机网络

[toc]

## 1 计算机网络体系结构

### 1.1 OSI和TCP/IP模型 ※※※※※

- OSI：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层
- TCP/IP：网络接口层、网际层、传输层、应用层
- 各层常见协议
  - 数据链路层：CSMA/CD，ARQ，PPP
  - 网络层：ARP，RARP，ICMP，OSPF
  - 传输层：NAT，TCP，UDP
  - 应用层（基于UDP）：DHCP，RIP，IGMP，DNS，SFTP
  - 应用层（基于TCP）：FTP，HTTP，BGP，SMTP，TELNET

### 1.2 协议三要素 ※※

语法、语义、同步

### 1.3 计算机网络分层的原因 ※※

- 各层相互独立，下层为上层提供服务，上层使用下层接口，将复杂问题分解为多个子问题
- 灵活性好，每一层可以用最合适的技术实现该层功能；易于实现和维护
- 促进标准化工作，可扩展性强

### 1.4 电路交换、报文交换、分组交换 ※※※

**电路**：传输前建立专用物理通信路径，一直独占。通信时延小，有序；但建立连接时间长，线路使用效率低。

**报文**：存储转发，交换单位是报文。无需建立连接，利用率高；但存储转发时延高，缓存空间大。

**分组**：存储转发，限制数据块大小。利用率高，加速传输，简化存储；但需要额外信息量，容易失序重复丢失

## 2 物理层

### 奈奎斯特定理、香农定理 ※

$$
奈奎斯特：理想低通信道下的极限数据传输速率=2W\log_2V\\
香农定理：信道的基线数据传输速率=W\log_2(1+S/N)
$$

其中，$W$是信道频率带宽（Hz），$V$是码元的离散电平数目，$S/N$是信噪比（经过$10\log_{10}(S/N)$）

## 3 数据链路层

### 3.1 IP地址和MAC地址的区别 

| 对比条目 |      MAC地址       |         IP地址         |
| :------: | :----------------: | :--------------------: |
| 工作地点 |     数据链路层     |         网络层         |
|   作用   | 区分网卡，有唯一性 | 区分用户，每个用户一个 |
| 地址性质 |      物理地址      |        逻辑地址        |

冲突域：由交换机划分；广播域：由路由器划分

### 3.2 ARP协议（Address Resolution Protocol，地址解析协议） ※※※

**用途**：将**同一广播域内**目标主机的IP地址解析为物理MAC地址（RARP：将MAC解析为IP）。是**网络层**协议。

**工作流程**：

- 发送数据的设备首先**检查ARP缓存表**（存储IP与MAC地址对）
- 若无则发送**广播ARP请求**，询问IP对应的MAC地址。
- 若有设备匹配，则回复**ARP应答消息**发送MAC地址；发送设备将其**添加至自己的ARP缓存表**，发送

### 3.3 CSMA/CD协议 ※※※※

先听后发，边发边听，冲突停发，随机延迟后重发

- CSMA（**载波监听多路访问**）
  - **非持续式**：侦听，**空闲则发**；若忙则**放弃监听**，**等待随机时间重新监听**
  - **p-持续式**：侦听，**空闲则以p的概率发送**，以（1-p）的概率延迟一个时间单元发送；若忙则**持续侦听直至空闲**
- CD（**冲突检测**）：传输数据过程中，边传边监听：
  - 若**争用期**（2倍单程传播时延）内无碰撞则独占信道可持续发送，若发生碰撞，则停止发送。
  - 检测到碰撞后，执行**二进制指数退避算法**，等待随机延迟后重发

无线局域网不适用CSMA/CD的原因：无线信道有传播延迟，存在信号干扰，隐藏终端，无法准确检测信号冲突

### 3.4 ARQ（Automatic Repeat reQuest，自动重传请求） ※※※

ARQ是数据链路层的流量控制和可靠传输机制。GBN和SR又称连续ARQ协议。$W_T+W_R\le2^n$

- **停止-等待协议**：发送窗口1，接收窗口1，一次发送一帧，收到确认才发下一帧，超时重传。信道利用率低
- **后退N帧协议**：发送窗口>1，接收窗口1，一次发送多帧，一次接收一帧，累积确认。超时重传出错帧及其后N帧
- **选择重传协议**：发送窗口≥接收窗口>1，只重传出现差错和超时的数据帧，接收方需设置接收窗口大小的帧缓冲区。重传后重组失序帧送交上层

## 4 网络层

### 4.1 路由算法

#### 4.1.1 内部网关协议（IGP，Interior Gateway Protocol） ※※※※※

是自治系统内的路由协议

- **距离-向量算法**：**RIP**（Routing Information Protocol，路由信息协议。**应用层，基于UDP**）
  - 只和**相邻路由器**进行信息交换，内容为**路由表**，按固定时间间隔交换，
  - 一条RIP路径最多15个路由器，**适用于小型网络**
- **链路状态算法**：**OSPF**（开放最短路径优先）
  - **洪泛法**发送**相邻路由器的链路状态**。最终每个路由器有一个链路状态数据库（**整个网络的拓扑结构**）

#### 4.1.2 外部网关协议（EGP，External Gateway Protocol） ※※※

不同自治系统之间的路由选择协议。例：BGP，每个自治系统选择一个路由器作为发言人，建立TCP连接

### 4.2 路由器的作用 ※※※

1. **路由选择**：根据路由器构造路由表并定期维护
2. **分组转发**：根据转发表，将分组从路由器输入端口转移到合适的输出端口

### 4.3 DHCP协议（动态主机配置协议） ※※※

应用层，基于UDP，用于动态分配IP地址和其他网络配置给计算机。均采用广播

主机**DHCP发现报文**；服务器响应**DHCP提供报文**，报文中包含IP；主机**DHCP请求报文**；服务器**DHCP确认报文**，分配IP

### 4.4 ICMP协议（网际控制报文协议） ※※

网络层协议，包含**差错报告报文**和**询问报文**，如PING，Tracert

### 4.5 IPv4

- **NAT**：将专用网络地址（内网）与外部网络地址相转换。基于传输层UDP
- **CIDR**：无类别编制，基于变长子网掩码。可用路由聚合把网络前缀相同的地址组成地址块

### 4.6 IPv6 ※※※

- 动机：IPv4地址不够用了。
- 大规模地址空间：128位地址；改进性能和效率：优化头部格式和地址分配；增强安全性

## 5 传输层

### 5.1 TCP和UDP的异同 ※※※※※

都是传输层协议，提供进程间的**端到端数据传输**服务

| TCP                                        | UDP                                        |
| ------------------------------------------ | ------------------------------------------ |
| 面向连接，可靠，用流量控制和拥塞控制，复杂 | 无连接，尽最大努力交付，简单。可能丢失数据 |
| 面向字节流                                 | 面向报文                                   |
| 首部20B                                    | 首部8B                                     |
| 适用于文件传输等可靠传输应用               | 适用于实时应用（视频会议、直播、ROS）      |

### 5.2 TCP

#### 5.2.1 三次握手和四次挥手 ※※※※

- **三次握手**：①客户端SYN发起TCP连接，②服务器SYN-ACK，③客户端ACK
- **四次挥手**：①客户端发送FIN，②服务器ACK半关闭状态，③待服务器没有数据发送时发送FIN，④客户端收到FIN后发送ACK，等待2MSL后关闭，服务器收到ACK后也关闭
- **为什么不能2次握手**：因为连接是双工的，2次只能保证服务器收到客户端的消息，服务器不知道客户端有没有连上
- **为什么等待2MSL（最长报文段寿命）**：因为网络不可靠，客户端回给服务器的ACK可能丢失

#### 5.2.2 TCP可靠传输 ※※※※

- **校验**（UDP也有）
- **序号**：TCP每个字节都编号
- （累计）**确认**：接收端收到数据后发送期待下一序号的ACK
- **重传**：超时未收到ACK（RTO，大于RTTS）重传，连续收到3个冗余ACK重传

#### 5.2.3 TCP流量控制 ※※※※

- **实现**：接收方根据自己的接收缓存大小，通过报文段的窗口字段通知rwnd，动态调整发送方发送速率
  - $swnd=\min(rwnd,cwnd)$

- **作用**：使发送方发送速率与接收方程序读取速率匹配，防止发送方发的太快

#### 5.2.4 TCP拥塞控制 ※※※※

- **慢启动**：TCP刚建立时拥塞窗口为1MSS（最大报文段长度），每收到新的ACK，**拥塞窗口cwnd指数增长**
- **拥塞避免**：cwnd达到阈值ssthresh后，进入拥塞避免，**每RTT线性增加一个MSS**
- **快重传**：接收方立即发送ACK，发送方收到**连续3个冗余ACK则重传相应报文段**，进入快恢复
- **快恢复**：收到3个连续ACK，**ssthresh**和cwnd都**减为cwnd的一半**（不是各自的一半，超时则cwnd置1）

## 6 应用层

### 6.1 网络应用模型 ※※※

- **客户服务器模型**：随时服务，方便管理，但可扩展性差
- **P2P模型**：提高资源利用率，可扩展性好，但不便管理，消息延迟

### 6.2 DNS（Domain Name System，域名解析协议） ※※※

基于UDP，**将域名映射为IP**

主机向本地域名服务器查询：**递归查询**；向其他域名服务器：**迭代查询**

过程：本地缓存 - 本地DNS服务器 - 根域名服务器 - 顶级域名服务器 - 权限域名服务器，过程中均先查找自己的缓存

### 6.3 HTTP和HTTPS ※※※

HTTP：超文本传输协议，基于TCP，**无连接，不需要建立HTTP连接**，cookie存客户端，一般持续连接（HTTP/1.1）

HTTPS：使用SSL协议对HTTP传输的数据进行加密，较为安全

### 6.4 点击网页会发生什么 ※※※※※

- **DNS** 域名解析
- **三次握手**，建立TCP连接
- **客户端发起**HTTP请求
- **服务器响应**HTTP请求，发送HTML文档
- 浏览器解析HTML代码，**请求其他资源**
- **四次挥手**，断开TCP连接
- 浏览器渲染页面，呈现给用户